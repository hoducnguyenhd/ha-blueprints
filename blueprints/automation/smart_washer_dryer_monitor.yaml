blueprint:
  name: Smart Washer / Dryer Monitor (Per-Device)
  description: >
    GiÃ¡m sÃ¡t mÃ¡y giáº·t / mÃ¡y sáº¥y / mÃ¡y rá»­a bÃ¡t.
    KhÃ´ng dÃ¹ng input_boolean global.
    Má»—i automation hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p, khÃ´ng xung Ä‘á»™t.
  domain: automation

  input:
    power_sensor:
      name: Cáº£m biáº¿n cÃ´ng suáº¥t (W)
      selector:
        entity:
          domain: sensor

    device_name:
      name: TÃªn thiáº¿t bá»‹
      default: MÃ¡y giáº·t
      selector:
        text:

    notify_service:
      name: Notify service
      default: notify.notify
      selector:
        text:

    running_power:
      name: NgÆ°á»¡ng xÃ¡c Ä‘á»‹nh mÃ¡y Ä‘ang cháº¡y (W)
      default: 10
      selector:
        number:
          min: 5
          max: 100
          step: 1

    finish_power:
      name: NgÆ°á»¡ng cÃ´ng suáº¥t nghá»‰ (W)
      default: 5
      selector:
        number:
          min: 1
          max: 20
          step: 1

    finish_time:
      name: Thá»i gian cÃ´ng suáº¥t tháº¥p Ä‘á»ƒ xÃ¡c nháº­n dá»«ng (phÃºt)
      default: 3
      selector:
        number:
          min: 1
          max: 10
          step: 1

    min_run_time:
      name: Thá»i gian cháº¡y tá»‘i thiá»ƒu (phÃºt)
      default: 60
      selector:
        number:
          min: 10
          max: 240
          step: 5

    overload_power:
      name: NgÆ°á»¡ng quÃ¡ táº£i / káº¹t (W)
      default: 700
      selector:
        number:
          min: 300
          max: 3000
          step: 50

    overload_time:
      name: Thá»i gian quÃ¡ táº£i (phÃºt)
      default: 2
      selector:
        number:
          min: 1
          max: 10
          step: 1

mode: restart

trigger:
  - platform: numeric_state
    entity_id: !input power_sensor
    above: !input running_power
    for: "00:01:00"

action:
  - variables:
      name: !input device_name
      start_time: "{{ now() }}"

  # ===== CHá»œ Káº¾T THÃšC / Lá»–I / QUÃ Táº¢I =====
  - wait_for_trigger:
      # === Káº¾T THÃšC ===
      - platform: numeric_state
        entity_id: !input power_sensor
        below: !input finish_power
        for:
          minutes: !input finish_time

      # === QUÃ Táº¢I ===
      - platform: numeric_state
        entity_id: !input power_sensor
        above: !input overload_power
        for:
          minutes: !input overload_time
    timeout:
      hours: 6

  - variables:
      run_minutes: >
        {{ (as_timestamp(now()) - as_timestamp(start_time)) / 60 }}

  # ===== PHÃ‚N LOáº I Káº¾T QUáº¢ =====
  - choose:

      # === QUÃ Táº¢I / Káº¸T ===
      - conditions:
          - condition: template
            value_template: >
              {{ trigger is not none and
                 trigger.platform == 'numeric_state' and
                 trigger.above is defined }}
        sequence:
          - service: !input notify_service
            data:
              title: "âš ï¸ {{ name }}"
              message: >
                {{ name }} cÃ³ dáº¥u hiá»‡u quÃ¡ táº£i hoáº·c káº¹t.
                CÃ´ng suáº¥t cao báº¥t thÆ°á»ng.

      # === GIáº¶T XONG BÃŒNH THÆ¯á»œNG ===
      - conditions:
          - condition: template
            value_template: "{{ run_minutes >= ( !input min_run_time ) }}"
        sequence:
          - service: !input notify_service
            data:
              title: "ğŸ§º {{ name }}"
              message: >
                {{ name }} Ä‘Ã£ cháº¡y xong.
                Thá»i gian: {{ run_minutes | round(0) }} phÃºt.

      # === Dá»ªNG Sá»šM / Lá»–I ===
      - conditions:
          - condition: template
            value_template: "{{ run_minutes < ( !input min_run_time ) }}"
        sequence:
          - service: !input notify_service
            data:
              title: "âŒ {{ name }}"
              message: >
                {{ name }} dá»«ng báº¥t thÆ°á»ng sau {{ run_minutes | round(0) }} phÃºt.
                CÃ³ thá»ƒ lá»—i hoáº·c máº¥t nÆ°á»›c.
