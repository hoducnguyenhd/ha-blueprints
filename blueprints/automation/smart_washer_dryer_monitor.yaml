blueprint:
  name: Smart Washer / Dryer Monitor
  description: >
    PhÃ¡t hiá»‡n mÃ¡y giáº·t/sáº¥y cháº¡y xong, dá»«ng sá»›m (lá»—i), quÃ¡ táº£i.
  domain: automation

  input:
    power_sensor:
      name: Cáº£m biáº¿n cÃ´ng suáº¥t (W)
      selector:
        entity:
          domain: sensor

    device_name:
      name: TÃªn thiáº¿t bá»‹
      default: MÃ¡y giáº·t
      selector:
        text:

    notify_targets:
      name: Danh sÃ¡ch ngÆ°á»i nháº­n thÃ´ng bÃ¡o
      description: >
        Nháº­p danh sÃ¡ch notify service (VD: notify.mobile_app_nguyen)
      selector:
        object:

    running_power:
      name: NgÆ°á»¡ng xÃ¡c Ä‘á»‹nh Ä‘ang cháº¡y (W)
      default: 10
      selector:
        number:
          min: 5
          max: 100
          step: 1

    finish_power:
      name: NgÆ°á»¡ng cÃ´ng suáº¥t nghá»‰ (W)
      default: 5
      selector:
        number:
          min: 1
          max: 20
          step: 1

    finish_time:
      name: Thá»i gian cÃ´ng suáº¥t tháº¥p xÃ¡c nháº­n dá»«ng (phÃºt)
      default: 3
      selector:
        number:
          min: 1
          max: 10
          step: 1

    min_run_time:
      name: Thá»i gian cháº¡y tá»‘i thiá»ƒu (phÃºt)
      default: 60
      selector:
        number:
          min: 10
          max: 240
          step: 5

    overload_power:
      name: NgÆ°á»¡ng quÃ¡ táº£i / káº¹t (W)
      default: 800
      selector:
        number:
          min: 300
          max: 3000
          step: 50

    overload_time:
      name: Thá»i gian quÃ¡ táº£i (phÃºt)
      default: 2
      selector:
        number:
          min: 1
          max: 10
          step: 1

mode: restart

trigger:
  # ===== Báº®T Äáº¦U CHáº Y =====
  - platform: numeric_state
    entity_id: !input power_sensor
    above: !input running_power
    for: "00:01:00"
    id: start

  # ===== QUÃ Táº¢I =====
  - platform: numeric_state
    entity_id: !input power_sensor
    above: !input overload_power
    for:
      minutes: !input overload_time
    id: overload

action:
  - variables:
      name: !input device_name
      power_entity: !input power_sensor
      start_time: "{{ now() }}"
      min_time: !input min_run_time
      targets: !input notify_targets

  # ===== Äá»¢I Káº¾T THÃšC =====
  - wait_for_trigger:
      - platform: numeric_state
        entity_id: !input power_sensor
        below: !input finish_power
        for:
          minutes: !input finish_time
    timeout:
      hours: 6

  - variables:
      run_minutes: >
        {{ (as_timestamp(now()) - as_timestamp(start_time)) / 60 }}

  - choose:

      # ===== QUÃ Táº¢I =====
      - conditions:
          - condition: trigger
            id: overload
        sequence:
          - service: script.notify_dynamic
            data:
              targets: "{{ targets }}"
              title: "âš ï¸ {{ name }}"
              message: >
                {{ name }} cÃ³ dáº¥u hiá»‡u quÃ¡ táº£i hoáº·c káº¹t.

      # ===== CHáº Y XONG =====
      - conditions:
          - condition: template
            value_template: "{{ run_minutes >= min_time }}"
        sequence:
          - service: script.notify_dynamic
            data:
              targets: "{{ targets }}"
              title: "ğŸ§º {{ name }}"
              message: >
                {{ name }} Ä‘Ã£ cháº¡y xong.
                Thá»i gian: {{ run_minutes | round(0) }} phÃºt.

      # ===== Dá»ªNG Sá»šM / Lá»–I =====
      - conditions:
          - condition: template
            value_template: "{{ run_minutes < min_time }}"
        sequence:
          - service: script.notify_dynamic
            data:
              targets: "{{ targets }}"
              title: "âŒ {{ name }}"
              message: >
                {{ name }} dá»«ng báº¥t thÆ°á»ng sau {{ run_minutes | round(0) }} phÃºt.
