blueprint:
  name: ESPHome Speaker – Embedded Sounds
  description: >
    Phát âm thanh cho ESPHome Speaker.
  domain: automation

  input:
    trigger_entity:
      name: Trigger
      selector:
        entity: {}

    speaker:
      name: Speaker
      selector:
        entity:
          domain: media_player

    volume:
      name: Volume
      default: 0.7
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          mode: slider

    sound_name:
      name: Sound (dropdown)
      default: Bell
      selector:
        select:
          options:
            - Bell
            - Chime
            - Alarm
            - Notify

    auto_stop:
      name: Auto stop (seconds)
      default: 5
      selector:
        number:
          min: 0
          max: 60
          step: 1

mode: restart

trigger:
  - platform: state
    entity_id: !input trigger_entity

variables:
  selected_sound_name: !input sound_name

  sound_map:
    Bell: "https://raw.githubusercontent.com/nguyenho/speaker-sounds/main/bell.mp3"
    Chime: "https://raw.githubusercontent.com/nguyenho/speaker-sounds/main/chime.mp3"
    Alarm: "https://raw.githubusercontent.com/hoducnguyenhd/ha-blueprints/main/blueprints/sounds/alarm.wav"
    Notify: "https://raw.githubusercontent.com/nguyenho/speaker-sounds/main/notify.mp3"

  selected_sound: >
    {{ sound_map[selected_sound_name] }}

action:
  - service: media_player.volume_set
    target:
      entity_id: !input speaker
    data:
      volume_level: !input volume

  - service: media_player.play_media
    target:
      entity_id: !input speaker
    data:
      media_content_id: "{{ selected_sound }}"
      media_content_type: music

  - choose:
      - conditions:
          - condition: numeric_state
            value_template: !input auto_stop
            above: 0
        sequence:
          - delay:
              seconds: !input auto_stop
          - service: media_player.stop
            target:
              entity_id: !input speaker
